name: ESG Hub Data Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'backend/seed/**'
      - 'backend/schema/**'
      - 'backend/embeddings/**'
  workflow_dispatch:

jobs:
  seed-database:
    name: Seed SurrealDB
    runs-on: ubuntu-latest
    
    services:
      surrealdb:
        image: surrealdb/surrealdb:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd "curl -f http://localhost:8000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Apply schema
        run: |
          echo "ğŸ“Š Applying SurrealDB schema..."
          for schema in backend/schema/*.surql; do
            echo "Applying $schema..."
            surreal import --conn http://localhost:8000 --user root --pass root --ns esg_hub --db production "$schema"
          done
      
      - name: Seed planetary boundaries
        run: |
          echo "ğŸŒ Seeding planetary boundaries..."
          python3 backend/seed/seed_boundaries.py
      
      - name: Seed ESG standards
        run: |
          echo "ğŸ“Š Seeding ESG standards..."
          python3 backend/seed/seed_standards.py
      
      - name: Seed social issues
        run: |
          echo "ğŸ‘¥ Seeding social issues..."
          python3 backend/seed/seed_social.py
      
      - name: Seed governance topics
        run: |
          echo "âš–ï¸ Seeding governance topics..."
          python3 backend/seed/seed_governance.py
      
      - name: Seed SDGs
        run: |
          echo "ğŸ¯ Seeding SDGs..."
          python3 backend/seed/seed_sdgs.py
      
      - name: Seed books
        run: |
          echo "ğŸ“š Seeding books..."
          python3 backend/seed/seed_books.py
      
      - name: Seed regulations
        run: |
          echo "ğŸ“œ Seeding regulations..."
          python3 backend/seed/seed_regulations.py
      
      - name: Create relationships
        run: |
          echo "ğŸ”— Creating relationships..."
          python3 backend/seed/seed_relationships.py
      
      - name: Generate embeddings
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ§  Generating embeddings..."
          python3 backend/embeddings/generate.py
      
      - name: Verify database
        run: |
          echo "âœ… Verifying database..."
          python3 -c "
import asyncio
from surrealdb import Surreal

async def verify():
    db = Surreal('ws://localhost:8000/rpc')
    await db.connect()
    await db.use('esg_hub', 'production')
    await db.signin({'user': 'root', 'pass': 'root'})
    
    tables = ['planetary_boundary', 'standard', 'social_issue', 'governance_topic', 'sdg', 'book', 'regulation']
    for table in tables:
        result = await db.query(f'SELECT count() FROM {table} GROUP ALL')
        count = result[0]['result'][0]['count'] if result[0]['result'] else 0
        print(f'{table}: {count} records')
    
    await db.close()

asyncio.run(verify())
"
      
      - name: Export database backup
        run: |
          echo "ğŸ’¾ Exporting database backup..."
          surreal export --conn http://localhost:8000 --user root --pass root --ns esg_hub --db production backup.surql
      
      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup
          path: backup.surql
          retention-days: 30
